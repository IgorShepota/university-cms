<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="UTF-8">
    <title>Course Assignments - University CMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <style>
      .table td {
        vertical-align: middle;
      }

      .edit-mode td {
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <div th:replace="fragments/navbar :: navbar"></div>

    <!-- Main container -->
    <div class="container mt-5">
      <h2>Course Assignments</h2>

      <!-- Add new Course Assignment form -->
      <div sec:authorize="hasRole('ADMIN')" class="row mb-4">
        <div class="col-md-3">
          <select id="courseSelect" class="form-select">
            <option value="">Select Course</option>
            <option th:each="course : ${activeCourses}" th:value="${course.id}"
                    th:text="${course.name}"></option>
          </select>
        </div>
        <div class="col-md-3">
          <select id="teacherSelect" class="form-select">
            <option value="">Select Teacher</option>
            <option th:each="teacher : ${teachers}" th:value="${teacher.id}"
                    th:text="${teacher.fullName}"></option>
          </select>
        </div>
        <div class="col-md-3">
          <select id="groupSelect" class="form-select">
            <option value="">Select Group</option>
            <option th:each="group : ${activeGroups}" th:value="${group.id}"
                    th:text="${group.name}"></option>
          </select>
        </div>
        <div class="col-md-3">
          <button id="addAssignmentBtn" class="btn btn-success">Add</button>
        </div>
      </div>

      <!-- Assignments Table -->
      <table class="table">
        <thead>
        <tr>
          <th scope="col">ID</th>
          <th scope="col">Course</th>
          <th scope="col">Teacher</th>
          <th scope="col">Group</th>
          <th scope="col" sec:authorize="hasRole('ADMIN')">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="assignment : ${assignments}" th:id="'assignment-' + ${assignment.id}">
          <td th:text="${assignment.id}">ID</td>
          <td>
            <span th:text="${assignment.courseName}" class="course-name"></span>
            <select class="form-select course-select d-none">
              <option th:value="${assignment.courseId}" th:text="${assignment.courseName}"
                      selected></option>
              <option th:each="course : ${activeCourses}"
                      th:if="${course.id != assignment.courseId}"
                      th:value="${course.id}"
                      th:text="${course.name}">
              </option>
            </select>
          </td>
          <td>
            <span th:text="${assignment.teacherFullName}" class="teacher-name"></span>
            <select class="form-select teacher-select d-none">
              <option th:value="${assignment.teacherId}" th:text="${assignment.teacherFullName}"
                      selected></option>
              <option th:each="teacher : ${teachers}"
                      th:if="${teacher.id != assignment.teacherId}"
                      th:value="${teacher.id}"
                      th:text="${teacher.fullName}">
              </option>
            </select>
          </td>
          <td>
            <span th:text="${assignment.groupName}" class="group-name"></span>
            <select class="form-select group-select d-none">
              <option value="" th:selected="${assignment.groupId == null}">No Group</option>
              <option th:if="${assignment.groupId != null}"
                      th:value="${assignment.groupId}"
                      th:text="${assignment.groupName}"
                      selected>
              </option>
              <option th:each="group : ${activeGroups}"
                      th:if="${group.id != assignment.groupId}"
                      th:value="${group.id}"
                      th:text="${group.name}">
              </option>
            </select>
          </td>
          <td sec:authorize="hasRole('ADMIN')">
            <button class="btn btn-primary btn-sm edit-btn">Edit</button>
            <button class="btn btn-success btn-sm save-btn d-none">Save</button>
            <button class="btn btn-danger btn-sm remove-btn">Remove</button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <script th:inline="javascript">
      $(document).ready(function () {
        var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");

        $(document).ajaxSend(function (e, xhr, options) {
          xhr.setRequestHeader(header, token);
        });

        // Handle adding
        $('#addAssignmentBtn').click(function () {
          var courseId = $('#courseSelect').val();
          var teacherId = $('#teacherSelect').val();
          var groupId = $('#groupSelect').val();

          if (!courseId || !teacherId) {
            alert('Please select a course and a teacher');
            return;
          }

          groupId = groupId === "" ? null : groupId;

          $.ajax({
            url: '/assignments/add',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
              courseId: courseId,
              teacherId: teacherId,
              groupId: groupId
            }),
            success: function (response) {
              location.reload();
            },
            error: function (xhr, status, error) {
              alert('Error adding assignment: ' + xhr.responseText);
            }
          });
        });

        // Handle editing
        $('.edit-btn').click(function () {
          var row = $(this).closest('tr');
          row.addClass('edit-mode');
          row.find('.course-name, .teacher-name, .group-name').addClass('d-none');
          row.find('.course-select, .teacher-select, .group-select').removeClass('d-none');

          var courseId = row.find('.course-select option:selected').val();
          var teacherId = row.find('.teacher-select option:selected').val();
          var groupId = row.find('.group-select option:selected').val();

          row.find('.course-select').val(courseId);
          row.find('.teacher-select').val(teacherId);
          row.find('.group-select').val(groupId);

          $(this).addClass('d-none');
          row.find('.save-btn').removeClass('d-none');
        });

        // Handle saving
        $('.save-btn').click(function () {
          var row = $(this).closest('tr');
          var assignmentId = row.attr('id').substring(row.attr('id').indexOf('-') + 1);
          console.log("Sending update request for assignment ID:", assignmentId);
          var courseId = row.find('.course-select').val();
          var teacherId = row.find('.teacher-select').val();
          var groupId = row.find('.group-select').val();

          groupId = groupId === "" ? null : groupId;

          $.ajax({
            url: '/assignments/update',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
              id: assignmentId,
              courseId: courseId,
              teacherId: teacherId,
              groupId: groupId
            }),
            success: function (response) {
              row.removeClass('edit-mode');
              location.reload();
            },
            error: function (xhr, status, error) {
              row.removeClass('edit-mode');
              console.error('Error updating assignment:', xhr.responseText);
              alert('Error updating assignment: ' + xhr.responseText);
            }
          });
        });

        // Handle removing
        $('.remove-btn').click(function () {
          var row = $(this).closest('tr');
          var assignmentId = row.attr('id').substring(row.attr('id').indexOf('-') + 1);

          if (confirm('Are you sure you want to delete this assignment?')) {
            $.ajax({
              url: '/assignments/' + assignmentId,
              type: 'DELETE',
              beforeSend: function (xhr) {
                xhr.setRequestHeader(header, token);
              },
              success: function (response) {
                row.remove();
              },
              error: function (xhr, status, error) {
                console.error('Error deleting assignment:', xhr.responseText);
                alert('Error deleting assignment: ' + xhr.responseText);
              }
            });
          }
        });
      });
    </script>
  </body>
</html>